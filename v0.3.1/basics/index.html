<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Code Basics · GeophysicalFlows.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">GeophysicalFlows.jl</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">Modules</span><ul><li><a class="tocitem" href="../modules/twodturb/">TwoDTurb Module</a></li><li><a class="tocitem" href="../modules/barotropicqg/">BarotropicQG Module</a></li><li><a class="tocitem" href="../modules/barotropicqgql/">BarotropicQGQL Module</a></li><li><a class="tocitem" href="../modules/multilayerqg/">MultilayerQG Module</a></li></ul></li><li><span class="tocitem">DocStrings</span><ul><li><a class="tocitem" href="../man/types/">Private types</a></li><li><a class="tocitem" href="../man/functions/">Functions</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Code Basics</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Code Basics</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/FourierFlows/GeophysicalFlows.jl/blob/master/docs/src/basics.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Code-Basics-1"><a class="docs-heading-anchor" href="#Code-Basics-1">Code Basics</a><a class="docs-heading-anchor-permalink" href="#Code-Basics-1" title="Permalink"></a></h1><h2 id="Basic-Notation-1"><a class="docs-heading-anchor" href="#Basic-Notation-1">Basic Notation</a><a class="docs-heading-anchor-permalink" href="#Basic-Notation-1" title="Permalink"></a></h2><p>The code solves partial differential equations of the general form:</p><div>\[\partial_t u = \mathcal{L}u + \mathcal{N}(u)\ .\]</div><p>(Note: ODEs are special cases of the above. Thus the code also solves ODEs.)</p><p>We decompose the right hand side of the above in a linear part (<span>$\mathcal{L}u$</span>) and a nonlinear part (<span>$\mathcal{N}(u)$</span>). The time steppers treat the linear and nonlinear parts differently.</p><p>Boundary conditions in all spatial dimensions are periodic. That allows us to expand all variables using a Fourier decomposition. For example, a variable <span>$\phi(x, t)$</span> that depends in one spatial dimension is expanded as:</p><div>\[\phi(x, t) = \sum_{k} \widehat{\phi}(k, t)\,e^{\mathrm{i} k x}\ ,\]</div><p>where wavenumbers <span>$k$</span> take the values <span>$\tfrac{2\pi}{L_x}[0,\pm 1,\pm 2,\dots]$</span>. The equation is time-stepped forward in Fourier space. That way <span>$u$</span> becomes the array with all Fourier coefficients of the solution.</p><p>The coefficients for the linear operator <span>$\mathcal{L}$</span> are stored in an array called <code>LC</code>. The term <span>$\mathcal{N}(u)$</span> is computed for by calling the function <code>calcN!</code>.</p><h2 id="Abstract-SuperTypes-1"><a class="docs-heading-anchor" href="#Abstract-SuperTypes-1">Abstract SuperTypes</a><a class="docs-heading-anchor-permalink" href="#Abstract-SuperTypes-1" title="Permalink"></a></h2><p>The code is divided along conceptual lines into problem-agnostic and problem-specific components. Files that contain problem-agnostic parts of the code are stored in <code>/src</code>. Files in <code>/src</code> define the domain, &#39;AbstractTypes&#39; that supertype problem-specific types, and time-stepper types and routines. Problem-specific modules are stored in <code>/src/physics</code>.</p><p>Below is a list of all Abstract Supertypes used by the code:</p><ul><li><p><code>AbstractGrid</code>: Includes all variables that have to do with the grid, both in physical space as well as in wavenumber space. Currently implemented are: <code>ZeroGrid</code> for ODEs, <code>OneGrid</code> for PDEs with one spatial dimension, and <code>TwoGrid</code> for PDEs with two spatial dimensions. Grids are generic and work for any problem of that particular dimension.</p></li><li><p><code>AbstractParams</code>: Includes all parameters or functions related with the problem do not vary throughout the integration.</p></li><li><p><code>AbstractVars</code>: Includes all variables of the problem that change along the integration.</p></li><li><p><code>AbstractEquation</code>: Includes the array with the coefficients of the linear part of the equation, <code>LC</code> as well as function <code>calcN!</code> that computes the nonlinear part of the equation.</p></li><li><p><code>AbstractState</code>: Includes the solution <code>sol</code> at current time-step as well as the time-step <code>dt</code>, the time <code>t</code>, and <code>step</code> which counts the number of time-steps taken.</p></li><li><p><code>AbstractTimeStepper</code>: Includes all details for the time-stepper (e.g., <code>dt</code>, various coefficients, <code>sol</code> at intermediate time-step values). Time-steppers are generic and work for any problem.</p></li><li><p><code>AbstractProblem</code>: A super-supertype that includes all of the above. That is <code>problem</code> includes <code>grid</code>, <code>vars</code>, <code>params</code>, <code>eqn</code>, <code>ts</code>, <code>state</code>, and also <code>t</code> and <code>step</code>.</p></li></ul><p>Grids and time-steppers are generic and work for any problem of that particular dimension. State and Problem just gathers things together. Thus, to write a solver for a new physical problem you only need to prescribe <code>params</code>, <code>vars</code>, the coefficients of the linear part, <code>LC</code>, and function <code>calcN!</code>.</p><h2 id="Source-code-organization-1"><a class="docs-heading-anchor" href="#Source-code-organization-1">Source code organization</a><a class="docs-heading-anchor-permalink" href="#Source-code-organization-1" title="Permalink"></a></h2><p>The code is divided along conceptual lines into problem-agnostic and problem-specific components. Files that contain problem-agnostic parts of the code are stored in <code>/src</code>. Files in <code>/src</code> define the domain, &#39;AbstractTypes&#39; that supertype problem-specific types, and time-stepper types and routines. Problem-specific modules are stores in <code>/src/physics</code>.</p><p>Here&#39;s an overview of the code structure:</p><ul><li><p><code>/src/</code></p><ul><li><p><code>FourierFlows.jl</code></p><ul><li>Defines supertyping AbstractParams, AbstractGrid, etc.</li><li>Defines a <code>Problem</code> type to organize the grid, vars, params, equation, and timestepper into a single structure.</li><li>Includes all sources files and physics files.</li></ul></li><li><p><code>timesteppers.jl</code>: defines modules and <code>stepforward!</code> routines for   various time-steppers. Current implemented time-steppers are:</p><ul><li>Forward Euler</li><li>3rd-order Adams-Bashforth (AB3)</li><li>4th-order Runge-Kutta (RK4)</li><li>4th-order Runge-Kutta Exponential Time Differencing (ETDRK4)</li><li>4th-order Dual Runge-Kutta (DualRK4)</li><li>4th-order Dual Runge-Kutta Exponential Time Differencing (DualETDRK4)</li></ul><p>For each time-stepper exists also a &quot;filtered&quot; version that filters out high-wavenumber spectral components of the solution. The <code>Dual</code> time-steppers evolve a state variable that comprises both of real valued         and complex valued fields.</p></li><li><p><code>physics/</code></p><ul><li><code>twodturb.jl</code>: Defines a <code>TwoDTurb</code> module that provides a solver for the two-dimensional vorticity equation.</li><li><code>barotropicqg.jl</code>: Defines a <code>BarotropicQG</code> module that provides several solvers for the barotropic QG model that permit beta, topography, beta + topography, and forcing.</li><li><code>kuramotosivashinsky.jl</code>: Defines a <code>KuramotoSivashinsky</code> module that solves the Kuramoto-Sivashinsky.</li><li><code>verticallyfourierboussinesq.jl</code>: Defines a <code>VerticallyFourierBoussinesq</code> module that solves the two-mode truncation of the Fourier series thin-layer approximation to the hydrostatic Boussinesq equations.</li><li><code>verticallycosinerboussinesq.jl</code>: Defines a <code>VerticallyCosineBoussinesq</code> module that solves the two-mode truncation of the Sin/Cos series thin-layer approximation to the hydrostatic Boussinesq equations.</li><li><code>traceradvdiff.jl</code>: Defines a <code>TracerAdvDiff</code> module that provides a solver for a two-dimensional and periodic tracer field in a given 2D flow (u, w), which can be an arbitrary function of x, z, and t.</li></ul></li></ul></li></ul><h2 id="Basic-steps-for-solving-a-problem:-step-through-an-example-script-1"><a class="docs-heading-anchor" href="#Basic-steps-for-solving-a-problem:-step-through-an-example-script-1">Basic steps for solving a problem: step through an example script</a><a class="docs-heading-anchor-permalink" href="#Basic-steps-for-solving-a-problem:-step-through-an-example-script-1" title="Permalink"></a></h2><p>To illustrate the basic steps for solving a problem consider the 1D Kuramoto-Sivashinsky equation for <span>$u(x, t)$</span>:</p><div>\[\partial_t u + \partial_x^4 u + \partial_x^2 u + u\partial_x u = 0\ ,\]</div><p>which in Fourier base reads:</p><div>\[\partial_t \widehat{u} = \underbrace{(- k_x^4 + k_x^2) \widehat{u}}_{\mathcal{L}\widehat{u}}
+ \underbrace{\widehat{ -u\partial_x u }}_{\mathcal{N}(\widehat{u})}\ .\]</div><p>The steps to construct an <code>AbstractProblem</code> for the above are:</p><ul><li>Construct an <code>AbstractGrid</code>; for this problem we use the <code>OneGrid</code>.</li><li>Construct an <code>AbstractParams</code>; for this problem <code>params</code> is be empty as there are no parameters in the equation. (Note that e.g., the domain size <code>Lx</code> and the number of gridpoints <code>nx</code> belong to the grid.)</li><li>Construct an <code>AbstractVars</code>; for this problem <code>vars</code> includes <span>$u$</span>, <span>$\partial_x u$</span>, <span>$u\partial_x u$</span> and their Fourier transforms <span>$\widehat{u}$</span>, <span>$\widehat{\partial_x u}$</span>, <span>$\widehat{u\partial_xu}$</span>.</li><li>Construct the equations by prescribing coefficients for the linear part as an array <code>LC</code> and a function <code>calcN!</code> that computes <span>$\mathcal{N}(\widehat{u})$</span>.</li><li>Construct the time-stepper which includes function <code>stepforward!</code> that time-steps the solution.</li><li>Construct the <code>state</code> and gather everything as an <code>AbstractProblem</code>.</li></ul><p>The example script found in  <code>examples/kuramotosivashinsky/trefethenexample.jl</code> demonstrates the above steps needed to construct an <code>AbstractProblem</code>. The <code>prob</code> is constructed by calling <code>prob = InitialValueProblem(nx=nx, Lx=Lx, dt=dt, stepper=&quot;ETDRK4&quot;)</code>. Looking into the  <code>InitialValueProblem</code> function we can see the above steps:</p><pre><code class="language-julia">function InitialValueProblem(;
     nx = 256,
     Lx = 2π,
     dt = 0.01,
stepper = &quot;RK4&quot;
)

g  = OneDGrid(nx, Lx)
pr = Params()
vs = Vars(g)
eq = Equation(pr, g)
ts = FourierFlows.autoconstructtimestepper(stepper, dt, eq.LC, g)

FourierFlows.Problem(g, vs, pr, eq, ts)
end</code></pre><p>The <code>OneDGrid</code> function is called for the grid. Within grid the wavenumber array is constructed:</p><pre><code class="language-julia">i1 = 0:Int(nx/2)
i2 = Int(-nx/2+1):-1
k = Array{T}(2π/Lx*cat(1, i1, i2))
kr = Array{T}(2π/Lx*cat(1, i1))</code></pre><p>For real-valued fields we use <code>rfft</code> and thus only positive wavenumbers are involved: array <code>kr</code>. E.g., for <code>nx=8</code> and <code>Lx=2π</code> the wavenumber grids are: <code>k = [0, 1, 2, 3, 4, -3, -2, -1]</code> and <code>kr = [0, 1, 2, 3, 4]</code>.</p><p>The construction of the grids only works for <em>even</em> number of grid points. Moreover, since the code relies on the <span>$\mathrm{FFT}$</span> algorithm, we suggest you use a power of 2 as the number of grid points, since then <span>$\mathrm{FFT}$</span> is most efficient. </p><p>Function <code>Vars(g)</code> initialize variables <code>u</code>, <code>ux</code>, and <code>uux</code> as real valued arrays of length <code>nx</code> and variables <code>uh</code>, <code>uxh</code>, and <code>uuxh</code> as complex valued arrays of length <code>nkr = Int(nx/2+1)</code> (the same length as <code>kr</code>). As a general convention variable names with <code>h</code> denote the Fourier transforms of the corresponding variable (<code>h</code> stands for &#39;hat&#39;).</p><p>The array <code>LC</code> is constructed by <code>Equation</code> function</p><pre><code class="language-julia">function Equation(p, g)
  LC = @. g.kr^2 - g.kr^4
  FourierFlows.Equation(LC, calcN!)
end</code></pre><p>Also <code>eq</code> includes function <code>calcN!</code> which computes the nonlinear term <span>$\mathcal{N}(\widehat{u})$</span>:</p><pre><code class="language-julia">function calcN!(N, sol, t, s, v, p, g)
  @. v.uh = sol
  @. v.uxh = im*g.kr*sol
  A_mul_B!(v.u, g.irfftplan, v.uh)
  A_mul_B!(v.ux, g.irfftplan, v.uxh)
  @. v.uux = v.u*v.ux
  A_mul_B!(v.uuxh, g.rfftplan, v.uux)
  @. N = -v.uuxh
  dealias!(N, g)
  nothing
end</code></pre><p>The time-stepper is constructed and stored as <code>ts</code>. Finally, all supertypes are gathered together as an <code>AbstractProblem</code>.</p><h2 id="Tutorials-1"><a class="docs-heading-anchor" href="#Tutorials-1">Tutorials</a><a class="docs-heading-anchor-permalink" href="#Tutorials-1" title="Permalink"></a></h2><ul><li><a href="../modules/twodturb/#TwoDTurb-Module-1">TwoDTurb Module</a></li><li><a href="../modules/barotropicqg/#BarotropicQG-Module-1">BarotropicQG Module</a></li></ul></article></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Tuesday 21 January 2020 04:14">Tuesday 21 January 2020</span>. Using Julia version 1.3.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
